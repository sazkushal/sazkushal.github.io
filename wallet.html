<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wallet | Need2Earn</title>
<link rel="stylesheet" href="global_style.css" />
<style>
  body { background:#0f172a; color:#f1f5f9; font-family:'Poppins',sans-serif; margin:0; }
  header, nav { display:flex; align-items:center; justify-content:space-between; padding:10px 20px; background:#1e293b; }
  header h1 { margin:0; font-size:20px; }
  .tasks-section { padding:15px; }
  .task-card { background:#1e293b; padding:15px; border-radius:12px; margin-bottom:15px; text-align:center; }

  .modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:200; }
  .modal-content { background:#1e293b; padding:25px; border-radius:12px; width:90%; max-width:400px; display:flex; flex-direction:column; align-items:center; text-align:center; }
  .modal-content .input-group { width:100%; margin:10px 0; display:flex; flex-direction:column; }
  .modal-content .input-group input { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color:#f1f5f9; }
  .modal-content button { width:100%; padding:10px; margin-top:10px; cursor:pointer; transition: transform 0.2s; }
  .modal-content button:hover { transform:scale(1.05); }

  .withdraw-options-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px; justify-items:center; }
  .withdraw-btn { padding:25px 0; width:130px; font-size:22px; font-weight:700; border-radius:16px; border:none; background:#3b82f6; color:#f1f5f9; cursor:pointer; transition: all 0.2s; box-shadow:0 4px 6px rgba(0,0,0,0.3); }
  .withdraw-btn:hover { transform:scale(1.05); background:#60a5fa; }
  .withdraw-btn.active { background:#2563eb; box-shadow:0 6px 8px rgba(0,0,0,0.4); }

  #confirm-withdraw { width:100%; padding:15px; margin-top:20px; font-weight:700; border:none; border-radius:12px; background:#10b981; color:#0f172a; cursor:pointer; transition: transform 0.2s; }
  #confirm-withdraw:hover { transform:scale(1.03); background:#22c55e; }

  #popup { position:fixed; bottom:20px; left:50%; transform: translateX(-50%) translateY(20px); background:#3b82f6; color:#f1f5f9; padding:14px 24px; border-radius:12px; font-weight:700; opacity:0; pointer-events:none; transition: opacity 0.5s ease, transform 0.5s ease; z-index:300; }
  #popup.show { opacity:1; transform: translateX(-50%) translateY(0); pointer-events:auto; }

  header .header-left img,
  header .header-right img,
  nav a img { width:24px; height:24px; vertical-align:middle; margin-right:5px; }

  /* Telegram Verify Popup */
  #verifyPopup {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:500;
  }
  #verifyPopup .verify-box {
    background:#1e293b; padding:25px; border-radius:12px; text-align:center; width:300px;
  }
  #verifyPopup img { width:80px; margin-bottom:15px; }
  #verifyPopup button {
    background:#0088cc; color:white; border:none; padding:10px 20px;
    border-radius:8px; cursor:pointer; margin-top:10px; font-weight:600;
  }
  #verifyPopup button:hover { background:#0aa0e8; }
</style>
</head>
<body>

<header>
  <div class="header-left"><img src="icons/back.png" alt="Back" onclick="history.back()"></div>
  <h1 class="logo">Wallet</h1>
  <div class="header-right"><img src="icons/records.png" alt="Records" onclick="location.href='records.html'"></div>
</header>

<main>
  <section id="balance-section" class="tasks-section"><p>Loading balance...</p></section>
  <section id="payment-section" class="tasks-section"><p>Loading payment info...</p></section>

  <section id="withdraw-section" class="tasks-section" style="display:none;">
    <h3>Select Amount to Withdraw</h3>
    <div class="withdraw-options-grid">
      <button class="withdraw-btn" data-amount="20">₹20</button>
      <button class="withdraw-btn" data-amount="50">₹50</button>
      <button class="withdraw-btn" data-amount="100">₹100</button>
      <button class="withdraw-btn" data-amount="300">₹300</button>
    </div>
    <button id="confirm-withdraw">Withdraw</button>
  </section>
</main>

<div id="payment-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Add Payment Method</h3>
    <div class="input-group"><label>Name</label><input type="text" id="pay_name" placeholder="Enter Name"></div>
    <div class="input-group"><label>UPI ID</label><input type="text" id="pay_upi" placeholder="Enter UPI ID"></div>
    <button id="save-payment">Submit</button>
    <button onclick="closeModal()" style="margin-top:10px;">Cancel</button>
  </div>
</div>

<!-- ✅ Telegram Verify Popup -->
<div id="verifyPopup">
  <div class="verify-box">
    <img src="icons/telegram.png" alt="Telegram">
    <h3>Verify with Telegram</h3>
    <p>Please verify your account to continue withdrawal.</p>
    <button id="verifyBtn">Verify with Telegram</button>
  </div>
</div>

<div id="popup"></div>

<nav class="bottom-nav">
  <a href="index.html"><img src="icons/home.png" alt="Home"><span>Home</span></a>
  <a href="wallet.html" class="active"><img src="icons/wallet.png" alt="Wallet"><span>Wallet</span></a>
  <a href="profile.html"><img src="icons/user.png" alt="Profile"><span>Profile</span></a>
  <a href="refersection.html"><img src="icons/users.png" alt="Refer"><span>Refer</span></a>
</nav>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = "https://hkfixjnwzkghapljsxzg.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhrZml4am53emtnaGFwbGpzeHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDYyODgsImV4cCI6MjA3NjcyMjI4OH0.vfaXH70jFUlNzqynIKDKyCpIH5P0SrrwRWROjfIB5EI";
const supabase = createClient(supabaseUrl, supabaseKey);

let user = JSON.parse(localStorage.getItem("need2earn_user"));
const balanceSection = document.getElementById("balance-section");
const paymentSection = document.getElementById("payment-section");
const withdrawSection = document.getElementById("withdraw-section");
const popup = document.getElementById("popup");
const verifyPopup = document.getElementById("verifyPopup");
console.log(user);
let paymentName = "";
let paymentUpi = "";

function showPopup(msg,color="#3b82f6"){
  popup.textContent=msg;
  popup.style.background=color;
  popup.classList.add("show");
  setTimeout(()=>popup.classList.remove("show"),3000);
}

window.openModal=()=>document.getElementById("payment-modal").style.display="flex";
window.closeModal=()=>document.getElementById("payment-modal").style.display="none";

window.addEventListener("DOMContentLoaded", async()=>{
  if(!user){
    balanceSection.innerHTML="<p>Please login to see balance.</p>";
    paymentSection.innerHTML="<p>Please login to access wallet.</p>";
    return;
  }

  await loadBalance();
  setInterval(loadBalance,5000);
  await loadPaymentMethod();

  document.querySelectorAll(".withdraw-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".withdraw-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    });
  });

  document.getElementById("confirm-withdraw").addEventListener("click", async()=>{
    // ✅ Telegram verification check
    const { data: userData } = await supabase.from("users").select("verified").eq("id", user.id).single();
    if(!userData || !userData.verified){
      verifyPopup.style.display = "flex";
      return;
    }
    createWithdrawal();
  });

  document.getElementById("verifyBtn").addEventListener("click", ()=>{
    window.open("https://t.me/n2everify", "_blank");
  });
});

async function loadBalance(){
  const { data, error } = await supabase.from("users").select("balance").eq("id",user.id).single();
  if(error) return showPopup(error.message,"red");
  balanceSection.innerHTML=`<div class="task-card"><h3>Balance: ₹${data.balance}</h3></div>`;
}

async function loadPaymentMethod(){
  const { data } = await supabase.from("users_paymentmode").select("*").eq("user_id",user.id).single();
  if(data){
    paymentSection.innerHTML=`<div class="task-card"><h3>${data.name}</h3><p>UPI: ${data.upi_id}</p></div>`;
    withdrawSection.style.display="block";
    paymentName = data.name;
    paymentUpi = data.upi_id;
    window.paymentMethod = data;
  } else{
    paymentSection.innerHTML=`<button class="submit-btn" onclick="openModal()">Add Payment Method</button>`;
    withdrawSection.style.display="none";
  }
}

document.getElementById("save-payment").addEventListener("click", async()=>{
  const name = document.getElementById("pay_name").value.trim();
  const upi = document.getElementById("pay_upi").value.trim();
  if(!name||!upi) return showPopup("Enter all fields","red");

  const { data,error } = await supabase.from("users_paymentmode").insert([{ user_id:user.id,name,upi_id:upi }]).select().single();
  if(error) return showPopup(error.message,"red");
  closeModal();
  await loadPaymentMethod();
  showPopup("Payment method added!");
});

async function createWithdrawal(){
  const selectedBtn = document.querySelector(".withdraw-btn.active");
  if(!selectedBtn) return showPopup("Select an amount","red");

  const payment = window.paymentMethod;
  if(!payment) return showPopup("Add payment method first","red");

  const amount = parseFloat(selectedBtn.dataset.amount);
  const orderId = Math.random().toString(36).substring(2,17).toUpperCase();

  const { data, error } = await supabase.rpc('perform_withdraw', {
    p_user_id: Number(user.id),
    p_payment_id: Number(payment.id),
    p_payment_name: paymentName,
    p_payment_upi: paymentUpi,
    p_amount: Number(amount),
    p_order_id: orderId
  });

  if (error) return showPopup(error.message, "red");

  const result = data?.[0];
  if (result) {
    showPopup(`Withdrawal successful! ID: ${result.withdrawal_id} | New Balance: ₹${result.new_balance}`);
    balanceSection.innerHTML = `<div class="task-card"><h3>Balance: ₹${result.new_balance}</h3></div>`;
  } else {
    showPopup("Withdrawal done, but no data returned", "orange");
  }
}
</script>
</body>
</html>
